name: Build and functionality tests

# 1) Caches LAMMPS's release repository
# 2) Builds LAMMPS (if changes are detected in the release branch)
# 3) Builds PAPRECA on top of LAMMPS
# 4) Builds PAPRECA source tests
# After completing steps 1-3, we can be certain that the PAPRECA version can be built without any issues
# 5) Performs source tests on the C++ code
# 6) Performs event tests (check the output to ensure that they succeed 100% for any given random seed)
# 7) Performs 20 hybrid kMC/MD steps on the "Phosphate Growth from TCP on Fe110" example.


on:
  workflow_dispatch: #Only trigger manually

jobs:

  buildLAMMPS:
    runs-on: ubuntu-latest

    steps:
    
    - name: Clone LAMMPS repository (release branch)
      run: |
        cd $HOME
        git clone -b release https://github.com/lammps/lammps.git mylammps
        cd ./mylammps
        mkdir -p build #Prepare the build folder so that you cache mylammps correctly
        git checkout release
        git pull

    - name: Install LAMMPS dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        sudo apt-get install mpich
        
    - name: Cache LAMMPS repository
      id: cache-lammps-repo
      uses: actions/cache@v3
      with:
        path: |
          $HOME/mylammps/build
          $HOME/mylammps/src
        key: ${{ runner.os }}-lammps-repo-${{ hashFiles('mylammps/src/**') }}
        restore-keys: |
          ${{ runner.os }}-lammps-repo-

    - name: Configure and build LAMMPS
      if: steps.cache-lammps-repo.outputs.cache-hit != 'true' #Only if there are changes to "mylammps" (i.e., if there are changes to the release branch)
      run: |
        cd $HOME/mylammps/build
        cmake -DPKG_MOLECULE=on -DPKG_RIGID=on -D PKG_QEQ=on -DBUILD_LIB=on -DBUILD_SHARED_LIBS=off -DBUILD_STATIC_LIBS=on ../cmake #Configure LAMMPS, build all required packages to run tests and enable static library building
        cmake --build .

    - name: Verify LAMMPS executable
      run: |
        cd $HOME/mylammps/build
        ./lmp -h

  #Build PAPRECA and PAPRECA test executables on top of LAMMPS.
  #Upload artefacts of both to be used in subsequent tests
  buildPAPRECA: 

    needs: buildLAMMPS
    
    runs-on: ubuntu-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v4 #Checkout PAPRECA repository

    - name: Restore LAMMPS cache
      id: cache-lammps
      uses: actions/cache@v3
      with:
        path: |
          $HOME/mylammps/build
          $HOME/mylammps/src
        key: ${{ runner.os }}-lammps-repo-${{ hashFiles('mylammps/src/**') }}
        restore-keys: |
          ${{ runner.os }}-lammps-repo-
          
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        sudo apt-get install mpich

    - name: Build PAPRECA
      run: |
        cd $HOME
        mkdir mypapreca; cd ./mypapreca
        mkdir build; cd build
        cmake $GITHUB_WORKSPACE/Installation/CMake -DLAMMPS_SRC_DIR=$HOME/mylammps/src/ -DLAMMPS_LIB_DIR=$HOME/mylammps/build/
        cmake --build .

    - name: Upload PAPRECA build artifact
      uses: actions/upload-artifact@v4
      with:
        name: PAPRECA-artifact
        path: $HOME/mypapreca/build

    - name: Build TESTS executable for PAPRECA
      run: |
        cd $HOME
        cp -r $GITHUB_WORKSPACE/tests/ ./
        cd ./tests/source\ tests/
        mkdir build; cd build
        cmake .. -DLAMMPS_SRC_DIR=$HOME/mylammps/src/ -DLAMMPS_LIB_DIR=$HOME/mylammps/build/ -DPAPRECA_SRC_DIR=$GITHUB_WORKSPACE/source
        cmake --build .

    - name: Upload artifact of PAPRECA test executable
      uses: actions/upload-artifact@v4
      with:
        name: PAPRECAtest-artifact
        path: $HOME/tests/source\ tests/build
